<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rer Embeddings - Nguma</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-weight: bold;
        }

        .status.info {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status.success {
            background: #e8f5e9;
            color: #388e3c;
        }

        .status.error {
            background: #ffebee;
            color: #d32f2f;
        }

        .status.warning {
            background: #fff3e0;
            color: #f57c00;
        }

        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }

        button:hover {
            background: #1565c0;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .log {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            display: none;
        }

        .log.visible {
            display: block;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
        }

        .log-entry.success {
            color: #388e3c;
        }

        .log-entry.error {
            color: #d32f2f;
        }

        .log-entry.info {
            color: #1976d2;
        }

        .progress {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        .progress.visible {
            display: block;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #1976d2, #42a5f5);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ü§ñ G√©n√©ration des Embeddings</h1>
        <p>Cliquez sur le bouton ci-dessous pour g√©n√©rer les embeddings de tous les articles de la base de
            connaissances.</p>

        <div id="status" class="status info">
            ‚è≥ En attente...
        </div>

        <div id="progress" class="progress">
            <div id="progress-bar" class="progress-bar" style="width: 0%">0%</div>
        </div>

        <button id="generateBtn" onclick="generateEmbeddings()">G√©n√©rer les Embeddings</button>

        <div id="log" class="log"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://kaqxoavnoabcnszzmwye.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImthcXhvYXZub2FiY25zenptd3llIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA0NjM1NTIsImV4cCI6MjA0NjAzOTU1Mn0.HuzKb9pWkF_Px7I5cBSTwgPIcgK26ubqnH5yTXyUfEk';
        const GEMINI_API_KEY = 'AIzaSyA6KU2E_BKJewFG8JfLIGdvhR3h68wCn1A'; // √Ä remplacer par votre vraie cl√©

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            logDiv.classList.add('visible');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }

        function updateProgress(current, total) {
            const progressDiv = document.getElementById('progress');
            const progressBar = document.getElementById('progress-bar');
            progressDiv.classList.add('visible');
            const percentage = Math.round((current / total) * 100);
            progressBar.style.width = percentage + '%';
            progressBar.textContent = `${current}/${total} (${percentage}%)`;
        }

        async function generateEmbeddings() {
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            updateStatus('üîç R√©cup√©ration des articles...', 'info');
            log('D√©marrage de la g√©n√©ration des embeddings...');

            try {
                // R√©cup√©rer les articles sans embedding
                const { data: articles, error: fetchError } = await (await fetch(
                    `${SUPABASE_URL}/rest/v1/knowledge_base?is_active=eq.true&embedding=is.null&select=id,title,content`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                )).json();

                if (fetchError || !articles) {
                    throw new Error('Erreur lors de la r√©cup√©ration des articles');
                }

                if (articles.length === 0) {
                    updateStatus('‚úÖ Tous les articles ont d√©j√† des embeddings', 'success');
                    log('Aucun article √† traiter', 'success');
                    btn.disabled = false;
                    return;
                }

                log(`${articles.length} articles √† traiter`, 'info');
                updateStatus(`üìö Traitement de ${articles.length} articles...`, 'info');

                let processed = 0;
                let errors = 0;

                for (const article of articles) {
                    try {
                        log(`G√©n√©ration embedding pour: "${article.title}"...`);

                        const textToEmbed = `${article.title}\n\n${article.content}`;

                        // G√©n√©rer l'embedding
                        const embeddingResponse = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/text-embedding-004:embedContent?key=${GEMINI_API_KEY}`,
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    model: 'models/text-embedding-004',
                                    content: { parts: [{ text: textToEmbed }] }
                                })
                            }
                        );

                        if (!embeddingResponse.ok) {
                            throw new Error(`Erreur API Gemini: ${embeddingResponse.statusText}`);
                        }

                        const embeddingData = await embeddingResponse.json();
                        const embedding = embeddingData.embedding.values;

                        // Sauvegarder l'embedding
                        const updateResponse = await fetch(
                            `${SUPABASE_URL}/rest/v1/knowledge_base?id=eq.${article.id}`,
                            {
                                method: 'PATCH',
                                headers: {
                                    'apikey': SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                    'Content-Type': 'application/json',
                                    'Prefer': 'return=minimal'
                                },
                                body: JSON.stringify({ embedding: embedding })
                            }
                        );

                        if (!updateResponse.ok) {
                            throw new Error(`Erreur sauvegarde: ${updateResponse.statusText}`);
                        }

                        processed++;
                        updateProgress(processed, articles.length);
                        log(`‚úÖ "${article.title}" - OK`, 'success');

                        // Pause pour respecter rate limit (2 req/sec)
                        await new Promise(resolve => setTimeout(resolve, 600));

                    } catch (error) {
                        errors++;
                        log(`‚ùå Erreur pour "${article.title}": ${error.message}`, 'error');
                    }
                }

                if (errors === 0) {
                    updateStatus(`‚úÖ Succ√®s ! ${processed} embeddings g√©n√©r√©s`, 'success');
                    log(`üéâ Termin√© avec succ√®s - ${processed}/${articles.length} trait√©s`, 'success');
                } else {
                    updateStatus(`‚ö†Ô∏è Termin√© avec ${errors} erreur(s) - ${processed} r√©ussis`, 'warning');
                    log(`‚ö†Ô∏è Termin√© - ${processed} r√©ussis, ${errors} erreurs`, 'warning');
                }

            } catch (error) {
                updateStatus(`‚ùå Erreur: ${error.message}`, 'error');
                log(`‚ùå Erreur g√©n√©rale: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>